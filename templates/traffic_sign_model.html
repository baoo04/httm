<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TrafficSignDetection - Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f1f5f9;
        margin: 0;
      }
      .sidebar {
        width: 230px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        background: #0d6efd;
        color: #fff;
        padding-top: 1rem;
        z-index: 1000;
      }
      .sidebar h4 {
        padding-left: 20px;
        margin-bottom: 1.5rem;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 10px 20px;
        margin: 4px 0;
        border-radius: 6px;
        transition: background 0.2s;
      }
      .sidebar a:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .sidebar .submenu {
        padding-left: 20px;
      }
      .navbar-custom {
        margin-left: 230px;
        background: #ffffff;
        border-bottom: 1px solid #dee2e6;
        z-index: 900;
      }
      .navbar-custom .navbar-brand {
        color: #0d6efd;
        font-weight: 600;
      }
      .content {
        margin-left: 230px;
        padding: 40px;
      }
      table th {
        background-color: #0d6efd;
        color: white;
        text-align: center;
      }
      table td {
        text-align: center;
      }
      .modal-header {
        background-color: #0d6efd;
        color: white;
      }
      .training-log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }
      .training-log p {
        margin: 3px 0;
        color: #495057;
      }
      .training-log .epoch-line {
        color: #0d6efd;
        font-weight: 600;
      }
      .training-log .metric-line {
        color: #28a745;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h4>Manage</h4>
      <a href="/home.html">Home</a>
      <a
        class="dropdown-toggle"
        data-bs-toggle="collapse"
        href="#trafficMenu"
        role="button"
        >Traffic Sign Manage</a
      >
      <div class="collapse submenu" id="trafficMenu">
        <a href="model.html?type=sign">➤ ManageModel</a>
      </div>

      <a
        class="dropdown-toggle"
        data-bs-toggle="collapse"
        href="#charMenu"
        role="button"
        >Character Manage</a
      >
      <div class="collapse submenu" id="charMenu">
        <a href="model.html?type=char">➤ ManageModel</a>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
      <div class="container-fluid">
        <span class="navbar-brand">TrafficSignDetection</span>
        <div class="ms-auto d-flex align-items-center">
          <span class="me-3">Dang Quan Bao</span>
          <a href="/logout" class="btn btn-primary btn-sm">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="content">
      <h3 id="pageTitle" class="mb-4"></h3>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Id</th>
            <th>Model Name</th>
            <th>Precision</th>
            <th>Recall</th>
            <th>F1 Score</th>
            <th>Version</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="modelTableBody"></tbody>
      </table>
    </div>

    <!-- Retrain Modal - Step 1: Select Dataset -->
    <div
      class="modal fade"
      id="retrainModal"
      tabindex="-1"
      aria-labelledby="retrainModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="retrainModalLabel">Retrain Model</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <!-- Dataset selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Select Dataset</label>
              <select id="datasetSelect" class="form-select">
                <option value="">-- Select a dataset --</option>
              </select>
            </div>

            <!-- Image selection area -->
            <div id="imageSection" style="display: none">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <div>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    id="selectAllBtn"
                  >
                    Select All
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    id="deselectAllBtn"
                  >
                    Deselect All
                  </button>
                </div>
                <span class="text-muted" id="selectedCount"
                  >0 images selected</span
                >
              </div>

              <div
                id="imageGrid"
                class="d-grid"
                style="
                  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                  gap: 10px;
                "
              ></div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary w-100"
              id="startRetrainBtn"
            >
              Start Retraining
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Retraining Progress Modal -->
    <div
      class="modal fade"
      id="retrainingModal"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Retraining Model</h5>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <div
                class="spinner-border text-primary mb-3"
                role="status"
                style="width: 3rem; height: 3rem"
              >
                <span class="visually-hidden">Retraining...</span>
              </div>
              <p id="retrainingStatus">Initializing training process...</p>
            </div>
            <div class="progress mb-3" style="height: 25px">
              <div
                class="progress-bar progress-bar-striped progress-bar-animated"
                id="retrainProgress"
                role="progressbar"
                style="width: 0%"
              >
                0%
              </div>
            </div>
            <div class="training-log" id="trainingLog">
              <p class="text-muted">Waiting for training to start...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Retraining Complete</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-success">
              <h6 class="alert-heading">✓ Model retrained successfully!</h6>
              <hr />
              <div id="retrainResults">
                <div class="row">
                  <div class="col-md-6">
                    <p class="mb-2">
                      <strong>Model Name:</strong>
                      <span id="newModelName">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Version:</strong> <span id="newVersion">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Precision:</strong>
                      <span id="newPrecision">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Recall:</strong> <span id="newRecall">-</span>
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-2">
                      <strong>F1 Score (mAP50):</strong>
                      <span id="newF1">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Sample Quantity:</strong>
                      <span id="sampleQty">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Dataset ID:</strong> <span id="datasetId">-</span>
                    </p>
                    <p class="mb-2">
                      <strong>Model Path:</strong><br />
                      <small class="text-muted" id="modelPath">-</small>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveModelBtn">
              Save Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const type = urlParams.get("type") || "sign";

      const pageTitle = document.getElementById("pageTitle");
      pageTitle.textContent =
        type === "sign"
          ? "Traffic Sign Model Management"
          : "Character Model Management";

      // API endpoints
      const API_BASE = "";
      const API_ENDPOINTS = {
        getModels: "/models",
        getDataset: "/datasets",
        retrain: "/retrain",
        saveModel: "/save_model",
      };

      // Global state variables
      let currentTrainedModel = null;
      let currentDatasetId = null;
      let currentModelId = null;
      let selectedImages = new Set();
      let allDatasets = [];
      let retrainModal, retrainingModal, resultModal;

      // Initialize page
      async function initPage() {
        await loadModels();
        initializeModals();
        setupEventListeners();
      }

      // Load models from backend
      async function loadModels() {
        try {
          const response = await fetch("/models");
          const res = await response.json();

          console.log(res);

          const tableBody = document.getElementById("modelTableBody");
          tableBody.innerHTML = "";

          res.models.forEach((model, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${model.id}</td>
              <td>${model.name}</td>
              <td>${(model.pre * 100).toFixed(1)}%</td>
              <td>${(model.recall * 100).toFixed(1)}%</td>
              <td>${(model.f1_score * 100).toFixed(1)}%</td>
              <td>v${model.version}</td>
              <td>
                <button class="btn btn-sm btn-primary retrain-btn"
                        data-model-id="${model.id}"
                        data-model-name="${model.name}">
                  Retrain
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });

          attachRetrainListeners();
        } catch (error) {
          console.error("Error loading models:", error);
          alert("Failed to load models. Please refresh the page.");
        }
      }

      // Attach event listeners to retrain buttons
      function attachRetrainListeners() {
        document.querySelectorAll(".retrain-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const modelId = btn.getAttribute("data-model-id");
            const modelName = btn.getAttribute("data-model-name");
            currentModelId = modelId;
            console.log(
              "Selected model ID:",
              currentModelId,
              "Name:",
              modelName
            );
            await openRetrainModal(modelName);
          });
        });
      }

      // Initialize Bootstrap modals
      function initializeModals() {
        retrainModal = new bootstrap.Modal(
          document.getElementById("retrainModal")
        );
        retrainingModal = new bootstrap.Modal(
          document.getElementById("retrainingModal")
        );
        resultModal = new bootstrap.Modal(
          document.getElementById("resultModal")
        );
      }

      // Load dataset list for dropdown
      async function loadDatasets() {
        try {
          const res = await fetch("/datasets");
          const data = await res.json();
          allDatasets = data.datasets || [];

          const select = document.getElementById("datasetSelect");
          select.innerHTML = '<option value="">-- Select a dataset --</option>';
          allDatasets.forEach((ds) => {
            const option = document.createElement("option");
            option.value = ds.id;
            option.textContent = ds.name;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Error loading datasets:", err);
          alert("Failed to load datasets.");
        }
      }

      // Open retrain modal
      async function openRetrainModal(modelName) {
        // Reset state
        currentDatasetId = null;
        selectedImages.clear();
        document.getElementById("imageSection").style.display = "none";
        document.getElementById("imageGrid").innerHTML = "";
        updateSelectedCount();

        // Load datasets if not already loaded
        if (allDatasets.length === 0) {
          await loadDatasets();
        }

        retrainModal.show();
      }

      // Update selected image count
      function updateSelectedCount() {
        const count = document.querySelectorAll(
          "#imageGrid .overlay:not(.d-none)"
        ).length;
        document.getElementById(
          "selectedCount"
        ).textContent = `${count} images selected`;
      }

      // Setup event listeners
      function setupEventListeners() {
        const datasetSelect = document.getElementById("datasetSelect");
        const imageSection = document.getElementById("imageSection");
        const imageGrid = document.getElementById("imageGrid");
        const selectAllBtn = document.getElementById("selectAllBtn");
        const deselectAllBtn = document.getElementById("deselectAllBtn");
        const startRetrainBtn = document.getElementById("startRetrainBtn");
        const saveModelBtn = document.getElementById("saveModelBtn");

        // Dataset selection change
        datasetSelect.addEventListener("change", () => {
          const datasetId = parseInt(datasetSelect.value);
          currentDatasetId = datasetId;

          if (!datasetId) {
            imageSection.style.display = "none";
            return;
          }

          const dataset = allDatasets.find((d) => d.id === datasetId);
          if (!dataset) return;

          // Clear and populate image grid
          imageGrid.innerHTML = "";
          selectedImages.clear();

          dataset.images.forEach((image) => {
            const div = document.createElement("div");
            div.className = "position-relative border rounded";
            div.style.width = "120px";
            div.style.height = "120px";
            div.style.overflow = "hidden";
            div.style.cursor = "pointer";
            div.dataset.imageId = image.id;

            div.innerHTML = `
              <img src="/samples/${image.id}" class="img-fluid w-100 h-100 object-fit-cover">
              <div class="overlay position-absolute top-0 start-0 w-100 h-100 bg-primary bg-opacity-50 d-none"></div>
            `;

            div.addEventListener("click", () => {
              const overlay = div.querySelector(".overlay");
              overlay.classList.toggle("d-none");

              if (!overlay.classList.contains("d-none")) {
                selectedImages.add(image.id);
              } else {
                selectedImages.delete(image.id);
              }

              updateSelectedCount();
            });

            imageGrid.appendChild(div);
          });

          imageSection.style.display = "block";
          updateSelectedCount();
        });

        // Select all button
        selectAllBtn.addEventListener("click", () => {
          document
            .querySelectorAll("#imageGrid .overlay")
            .forEach((overlay) => {
              overlay.classList.remove("d-none");
              const imageId = parseInt(overlay.closest("div").dataset.imageId);
              selectedImages.add(imageId);
            });
          updateSelectedCount();
        });

        // Deselect all button
        deselectAllBtn.addEventListener("click", () => {
          document
            .querySelectorAll("#imageGrid .overlay")
            .forEach((overlay) => {
              overlay.classList.add("d-none");
            });
          selectedImages.clear();
          updateSelectedCount();
        });

        // Start retraining button
        startRetrainBtn.addEventListener("click", async () => {
          if (!currentDatasetId || selectedImages.size === 0) {
            alert("Please select a dataset and at least one image!");
            return;
          }

          const payload = {
            dataset_id: currentDatasetId,
            image_ids: Array.from(selectedImages),
          };

          startRetrainBtn.disabled = true;
          startRetrainBtn.textContent = "Retraining...";

          try {
            const res = await fetch(`/models/${currentModelId}/retrain`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await res.json();

            if (res.ok) {
              currentTrainedModel = result;
              retrainModal.hide();
              showRetrainResults(result);
              resultModal.show();
            } else {
              alert("⚠️ Error: " + (result.error || "Retrain failed"));
            }
          } catch (err) {
            console.error(err);
            alert("An unexpected error occurred.");
          } finally {
            startRetrainBtn.disabled = false;
            startRetrainBtn.textContent = "Start Retraining";
          }
        });

        // Save model button
        saveModelBtn.addEventListener("click", async () => {
          if (!currentTrainedModel) {
            alert("No model data to save!");
            return;
          }

          saveModelBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
          saveModelBtn.disabled = true;

          try {
            const response = await fetch(`/models/${currentModelId}/save`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (!response.ok) {
              throw new Error("Failed to save model");
            }

            const result = await response.json();

            saveModelBtn.innerHTML = "✓ Saved!";
            saveModelBtn.classList.remove("btn-primary");
            saveModelBtn.classList.add("btn-success");

            setTimeout(() => {
              resultModal.hide();
              setTimeout(() => {
                alert(
                  "Model saved successfully!\n\nThe new model has been saved to the database.\nPage will reload to show updated data."
                );
                location.reload();
              }, 300);
            }, 1000);
          } catch (error) {
            console.error("Save error:", error);
            saveModelBtn.innerHTML = "Save Model";
            saveModelBtn.disabled = false;
            saveModelBtn.classList.remove("btn-success");
            saveModelBtn.classList.add("btn-primary");
            alert("Failed to save model: " + error.message);
          }
        });
      }

      // Show retrain results
      function showRetrainResults(model) {
        document.getElementById("newModelName").textContent = model.name || "-";
        document.getElementById("newVersion").textContent =
          "v" + (model.version || "-");
        document.getElementById("newPrecision").textContent =
          ((model.pre || 0) * 100).toFixed(2) + "%";
        document.getElementById("newRecall").textContent =
          ((model.recall || 0) * 100).toFixed(2) + "%";
        document.getElementById("newF1").textContent =
          ((model.f1_score || 0) * 100).toFixed(2) + "%";
        document.getElementById("sampleQty").textContent =
          model.sample_quantity || "-";
        document.getElementById("datasetId").textContent =
          model.dataset_id || "-";
        document.getElementById("modelPath").textContent = model.path || "-";
      }

      // Initialize the page
      initPage();
    </script>
  </body>
</html>
